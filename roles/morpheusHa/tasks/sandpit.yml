--- 
#- name: Sort hosts by IP address
#  set_fact:
#    sorted_hosts: "{{ groups['morph'] | map('extract', hostvars, ['ansible_default_ipv4', 'address']) | sort }}"
#
#- name: Get hostname and IP address of the first host
#  debug:
#    msg: "Hostname: {{ hostvars[first_host]['ansible_hostname'] }}, IP Address: {{ hostvars[first_host]['ansible_default_ipv4']['address'] }}"
#  vars:
#    first_host: "{{ sorted_hosts | first }}"
- name: Get first IP address of host in the morph group. This will be our SOT node for RabbitMQ clustering
  set_fact:
    rabbitmq_sot: "{{ groups['morph'] | map('extract', hostvars, ['ansible_eth0', 'ipv4', 'address']) | list | sort | first}}"

- debug:
    var: rabbitmq_sot

- name: Get hostname of the SOT node
  set_fact:
    rabbitmq_sot_name: "{{ ansible_hostname }}"
  when: ansible_eth0.ipv4.address == "{{ rabbitmq_sot }}"

- name: Write SOT hostname to a file
  file:
    path: /var/tmp/sot
    state: touch
  when: ansible_eth0.ipv4.address == "{{ rabbitmq_sot }}"

- name: Write fact to file
  lineinfile:
    path: /var/tmp/sot
    line: "{{ rabbitmq_sot_name }}"
  when: ansible_eth0.ipv4.address == "{{ rabbitmq_sot }}"
    